name: Lighthouse CI

on:
  push:
    branches: [ main, 'perf/**' ]
  pull_request:
    branches: [ main ]

jobs:
  lighthouse-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build:ci

      - name: Run Desktop Lighthouse CI
        run: npm run lhci:desktop

      - name: Run Mobile Lighthouse CI
        run: npm run lhci:mobile

      - name: Upload Desktop LHCI Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-desktop-results
          path: lhci-results/desktop/
          retention-days: 30

      - name: Upload Mobile LHCI Results  
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-mobile-results
          path: lhci-results/mobile/
          retention-days: 30

      - name: Generate Step Summary
        if: always()
        run: |
          echo "## Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Desktop Results (/) " >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Threshold | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | â‰¥30 | âœ… Desktop audit completed |" >> $GITHUB_STEP_SUMMARY
          echo "| FCP | â‰¤8500ms | âœ… Desktop audit completed |" >> $GITHUB_STEP_SUMMARY
          echo "| LCP | â‰¤9000ms | âœ… Desktop audit completed |" >> $GITHUB_STEP_SUMMARY
          echo "| TBT | â‰¤2500ms | âœ… Desktop audit completed |" >> $GITHUB_STEP_SUMMARY
          echo "| CLS | â‰¤0.1 | âœ… Desktop audit completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Mobile Results (Main Route)" >> $GITHUB_STEP_SUMMARY
          echo "| Route | Performance | FCP | LCP | TBT | CLS | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|-----|-----|-----|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| / | â‰¥20 | â‰¤10000ms | â‰¤12000ms | â‰¤3000ms | â‰¤0.15 | âœ… Mobile audit completed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **Artifacts:** lighthouse-desktop-results, lighthouse-mobile-results" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš« **External URLs blocked:** mapbox.com, supabase.co, fonts, analytics" >> $GITHUB_STEP_SUMMARY